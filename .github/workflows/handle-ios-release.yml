name: Handle iOS SDK Release

on:
  repository_dispatch:
    types: [ios_release]

jobs:
  update-ios-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ secrets.SERVICE_ACCOUNT_PAT }}

      - name: Extract and validate iOS SDK version
        id: new_version
        run: |
          NEW_VERSION="${{ github.event.client_payload.tag }}"
          echo "New iOS SDK version from dispatch: $NEW_VERSION"

          # Validate semver format (X.Y.Z)
          if ! echo "$NEW_VERSION" | grep -qE '^\d+\.\d+\.\d+$'; then
            echo "Error: Invalid version format '$NEW_VERSION'. Expected semver format (e.g., 6.4.0)"
            exit 1
          fi

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Extract current version from podspec
        id: current_version
        run: |
          PODSPEC_FILE="ios/airwallex_payment_flutter.podspec"

          if [ ! -f "$PODSPEC_FILE" ]; then
            echo "Error: Podspec file not found at $PODSPEC_FILE"
            exit 1
          fi

          # Extract version from airwallex_version = '...' or airwallex_version = '~> ...'
          CURRENT_VERSION=$(grep "airwallex_version = " "$PODSPEC_FILE" | sed -E "s/.*airwallex_version = '(~> )?([0-9.]+)'.*/\2/")

          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: Could not extract current version from $PODSPEC_FILE"
            exit 1
          fi

          echo "Current iOS SDK version in podspec: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Compare versions
        id: version_check
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"

          echo "Comparing versions: new=$NEW_VERSION vs current=$CURRENT_VERSION"

          # Use sort -V for semantic version comparison
          # If new version is the highest, it will be on the last line
          HIGHEST=$(printf "%s\n%s" "$NEW_VERSION" "$CURRENT_VERSION" | sort -V | tail -n1)

          if [ "$NEW_VERSION" = "$CURRENT_VERSION" ]; then
            echo "Version already up-to-date. Skipping."
            echo "should_update=false" >> $GITHUB_OUTPUT
          elif [ "$HIGHEST" = "$NEW_VERSION" ]; then
            echo "New version is newer. Proceeding with update."
            echo "should_update=true" >> $GITHUB_OUTPUT
          else
            echo "New version $NEW_VERSION is not newer than current version $CURRENT_VERSION. Skipping."
            echo "should_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update podspec dependency
        if: steps.version_check.outputs.should_update == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          PODSPEC_FILE="ios/airwallex_payment_flutter.podspec"

          echo "Updating $PODSPEC_FILE to version ~> $NEW_VERSION"

          # Update the airwallex_version line to use pessimistic operator (~>)
          sed -i "s/airwallex_version = '.*'/airwallex_version = '~> $NEW_VERSION'/" "$PODSPEC_FILE"

          echo "Updated podspec:"
          grep "airwallex_version" "$PODSPEC_FILE"

      - name: Create Pull Request
        if: steps.version_check.outputs.should_update == 'true'
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          token: ${{ secrets.SERVICE_ACCOUNT_PAT }}
          commit-message: "chore: update iOS SDK to ${{ steps.new_version.outputs.version }}"
          branch: "update-ios-sdk-${{ steps.new_version.outputs.version }}"
          delete-branch: true
          title: "Update iOS SDK to ${{ steps.new_version.outputs.version }}"
          body: |
            ## Summary
            This PR updates the Airwallex iOS SDK dependency to version `${{ steps.new_version.outputs.version }}`.

            ### Changes
            - Updated iOS SDK dependency in podspec from `${{ steps.current_version.outputs.version }}` to `${{ steps.new_version.outputs.version }}`

            ### Triggered By
            Automated update from iOS SDK release `${{ steps.new_version.outputs.version }}`

            ---
            ðŸ¤– Generated automatically by repository dispatch event
          base: main
          labels: |
            dependencies
            automated
